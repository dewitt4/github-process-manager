{% extends "base.html" %}

{% block title %}Settings - RAG Chatbot{% endblock %}

{% block content %}
<div class="settings-container">
    <h2>‚öôÔ∏è Settings & Configuration</h2>

    <!-- GitHub Settings -->
    <div class="settings-section">
        <h3>üîó GitHub Repository Connection</h3>

        {% if github_connected and repo_info %}
        <div class="info-card">
            <h4>‚úÖ Connected Repository</h4>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Repository:</span>
                    <span class="info-value">{{ repo_info.name }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Description:</span>
                    <span class="info-value">{{ repo_info.description or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Language:</span>
                    <span class="info-value">{{ repo_info.language or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Stars:</span>
                    <span class="info-value">‚≠ê {{ repo_info.stars }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Open Issues:</span>
                    <span class="info-value">{{ repo_info.open_issues }}</span>
                </div>
            </div>
        </div>
        {% else %}
        <p class="warning-text">‚ö†Ô∏è Not connected to a GitHub repository</p>
        {% endif %}

        <div class="form-group">
            <label for="repo-url">Repository URL:</label>
            <input type="text" id="repo-url" placeholder="https://github.com/username/repository" class="input-field">
            <button class="btn-primary" id="connect-btn">Connect Repository</button>
        </div>
        <div id="github-status" class="status-message"></div>
    </div>

    <!-- GitHub Actions -->
    <div class="settings-section">
        <h3>‚ö° GitHub Actions</h3>

        <button class="btn-secondary" id="load-workflows-btn">Load Workflows</button>

        <div id="workflows-container" style="margin-top: 1rem;">
            <!-- Workflows will be loaded here -->
        </div>

        <div id="workflow-status" class="status-message"></div>
    </div>

    <!-- Process Analysis Workflow -->
    <div class="settings-section">
        <h3>üìä Process Analysis & Documentation (GitHub Actions)</h3>
    
        <p class="info-text">Generate process analysis reports using GitHub Actions workflow. Supports SOX controls, MLOps workflows, DevOps pipelines, and general documentation.</p>
    
        <div class="form-group">
            <label for="sox-control-name">Process Name:</label>
            <input type="text" id="sox-control-name" placeholder="e.g., Model Deployment Pipeline, Revenue Control, CI/CD Process" class="input-field">
        </div>
    
        <div class="form-group">
            <label for="sox-control-data">Process Data/Context:</label>
            <textarea id="sox-control-data" rows="4" placeholder="Enter process details, requirements, or context..."
                class="input-field"></textarea>
        </div>
    
        <div class="form-group">
            <label for="sox-analysis-type">Analysis Type:</label>
            <select id="sox-analysis-type" class="input-field">
                <option value="standard">Standard</option>
                <option value="detailed">Detailed</option>
                <option value="summary">Summary</option>
            </select>
        </div>
    
        <button class="btn-primary" id="trigger-sox-btn">üöÄ Generate Report via GitHub Actions</button>
        <div id="sox-workflow-status" class="status-message"></div>
    
        <div id="sox-progress" style="display: none; margin-top: 1rem;">
            <div class="info-card">
                <h4>‚è≥ Workflow in Progress</h4>
                <p>Run ID: <span id="sox-run-id"></span></p>
                <p>Status: <span id="sox-run-status"></span></p>
                <button class="btn-secondary btn-small" id="check-sox-artifact-btn">Check for Report</button>
            </div>
        </div>
    </div>
    
    <!-- Generated Reports -->
    <div class="settings-section">
        <h3>üìÑ Generated Reports</h3>
    
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <p class="info-text">Word documents generated by the chatbot and GitHub Actions.</p>
            <div>
                <button class="btn-secondary btn-small" id="refresh-reports-btn">üîÑ Refresh</button>
                <button class="btn-danger btn-small" id="cleanup-reports-btn">üóëÔ∏è Clear Old (24h+)</button>
            </div>
        </div>
    
        <div id="reports-list" class="info-card">
            <p class="info-text">Loading reports...</p>
        </div>
    
        <div id="reports-status" class="status-message"></div>
    </div>

    <!-- RAG Database Settings -->
    <div class="settings-section">
        <h3>üìö RAG Document Database</h3>

        <div class="info-card">
            <div class="info-item">
                <span class="info-label">Total Document Chunks:</span>
                <span class="info-value" id="total-chunks">{{ rag_stats.total_chunks or 0 }}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Collection:</span>
                <span class="info-value">{{ rag_stats.collection_name or 'N/A' }}</span>
            </div>
        </div>

        <button class="btn-danger" id="clear-rag-btn">Clear All Documents</button>
        <div id="rag-status" class="status-message"></div>
    </div>

    <!-- AI Configuration -->
    <div class="settings-section">
        <h3>ü§ñ AI System Prompt Configuration</h3>

        <p class="info-text">Customize how the AI assistant behaves and responds. Choose a template or create your own custom prompt.</p>

        <div class="form-group">
            <label for="prompt-template">Prompt Template:</label>
            <select id="prompt-template" class="input-field">
                <option value="default">Default - General AI Assistant</option>
                <option value="technical">Technical - Documentation Expert</option>
                <option value="auditor">Auditor - Compliance Specialist</option>
                <option value="developer">Developer - Software Engineer</option>
                <option value="analyst">Analyst - Process Consultant</option>
                <option value="educator">Educator - Technical Mentor</option>
                <option value="custom">Custom - Write Your Own</option>
            </select>
        </div>

        <div id="template-preview" class="info-card" style="margin-bottom: 1rem;">
            <strong>Current Prompt:</strong>
            <p id="preview-text" style="margin-top: 0.5rem; font-style: italic;"></p>
        </div>

        <div id="custom-prompt-editor" style="display: none;">
            <div class="form-group">
                <label for="custom-prompt-text">Custom System Prompt:</label>
                <textarea id="custom-prompt-text" rows="6" 
                    placeholder="Enter your custom system prompt here..." 
                    class="input-field"></textarea>
                <small class="info-text">üí° Tip: Define the AI's role, expertise, and response style. Be specific about how it should format responses.</small>
            </div>
        </div>

        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-primary" id="update-prompt-btn">üíæ Save Prompt</button>
            <button class="btn-secondary" id="reset-prompt-btn">üîÑ Reset to Default</button>
        </div>
        
        <div id="prompt-status" class="status-message"></div>
        
        <div class="info-card" style="margin-top: 1rem; background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <p style="margin: 0;"><strong>‚ÑπÔ∏è Note:</strong> Prompt changes are session-only. To make permanent changes, edit the SYSTEM_PROMPT_TEMPLATE or CUSTOM_SYSTEM_PROMPT in your .env file.</p>
        </div>
    </div>

    <!-- Document Template Configuration -->
    <div class="settings-section">
        <h3>üìÑ Document Template Configuration</h3>

        <p class="info-text">Customize Word document branding and default template type. Changes are session-based until saved to .env file.</p>

        <div class="form-group">
            <label for="project-name">Project Name:</label>
            <input type="text" id="project-name" placeholder="GitHub Process Manager" class="input-field">
            <small class="info-text">Displayed in document headers</small>
        </div>

        <div class="form-group">
            <label for="company-name">Company Name (Optional):</label>
            <input type="text" id="company-name" placeholder="Leave empty for generic" class="input-field">
            <small class="info-text">Added to document headers if provided</small>
        </div>

        <div class="form-group">
            <label for="brand-color">Brand Color:</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="color" id="brand-color-picker" value="#4A90E2" style="width: 60px; height: 40px; border: none; cursor: pointer;">
                <input type="text" id="brand-color" placeholder="#4A90E2" class="input-field" style="flex: 1;" maxlength="7" pattern="^#[0-9A-Fa-f]{6}$">
            </div>
            <small class="info-text">Hex color for document headings and styling</small>
        </div>

        <div class="form-group">
            <label for="default-template">Default Template Type:</label>
            <select id="default-template" class="input-field">
                <option value="generic">Generic - General Purpose Documentation</option>
                <option value="sox_audit">SOX Audit - Compliance Reports</option>
                <option value="mlops_workflow">MLOps Workflow - ML Pipeline Docs</option>
                <option value="devops_pipeline">DevOps Pipeline - CI/CD Documentation</option>
            </select>
            <small class="info-text">Default template used for Word document generation</small>
        </div>

        <div class="form-group">
            <label for="logo-path">Document Logo Path (Optional):</label>
            <input type="text" id="logo-path" placeholder="/path/to/logo.png" class="input-field">
            <small class="info-text">Path to logo image (.png, .jpg, .jpeg) for document headers</small>
        </div>

        <div id="template-config-preview" class="info-card" style="margin-bottom: 1rem;">
            <strong>Current Configuration:</strong>
            <div style="margin-top: 0.5rem;">
                <div style="margin-bottom: 0.5rem;">
                    <strong>Header:</strong> 
                    <span id="preview-header" style="font-style: italic;"></span>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <strong>Color:</strong> 
                    <span id="preview-color-box" style="display: inline-block; width: 20px; height: 20px; border: 1px solid #ccc; vertical-align: middle;"></span>
                    <span id="preview-color-text" style="margin-left: 0.5rem;"></span>
                </div>
                <div>
                    <strong>Template:</strong> 
                    <span id="preview-template" style="font-style: italic;"></span>
                </div>
            </div>
        </div>

        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-primary" id="save-doc-config-btn">üíæ Save Configuration</button>
            <button class="btn-secondary" id="reset-doc-config-btn">üîÑ Reset to Defaults</button>
        </div>
        
        <div id="doc-config-status" class="status-message"></div>
        
        <div class="info-card" style="margin-top: 1rem; background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <p style="margin: 0;"><strong>‚ÑπÔ∏è Note:</strong> Configuration changes are session-only. For permanent changes, update PROJECT_NAME, COMPANY_NAME, BRAND_COLOR, DEFAULT_TEMPLATE_TYPE, and DOCUMENT_LOGO_PATH in your .env file.</p>
        </div>
    </div>

    <!-- System Information -->
    <div class="settings-section">
        <h3>‚ÑπÔ∏è System Information</h3>

        <div class="info-card">
            <div class="info-item">
                <span class="info-label">Gemini API:</span>
                <span class="info-value">‚úÖ Configured</span>
            </div>
            <div class="info-item">
                <span class="info-label">Supported File Types:</span>
                <span class="info-value">.txt, .pdf, .docx</span>
            </div>
            <div class="info-item">
                <span class="info-label">Max File Size:</span>
                <span class="info-value">16 MB</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const connectBtn = document.getElementById('connect-btn');
    const repoUrlInput = document.getElementById('repo-url');
    const githubStatus = document.getElementById('github-status');
    const clearRagBtn = document.getElementById('clear-rag-btn');
    const ragStatus = document.getElementById('rag-status');
    const loadWorkflowsBtn = document.getElementById('load-workflows-btn');
    const workflowsContainer = document.getElementById('workflows-container');
    const workflowStatus = document.getElementById('workflow-status');

    // Connect to GitHub repository
    connectBtn.addEventListener('click', async () => {
        const repoUrl = repoUrlInput.value.trim();
        if (!repoUrl) {
            showStatus(githubStatus, '‚ùå Please enter a repository URL', 'error');
            return;
        }

        connectBtn.disabled = true;
        showStatus(githubStatus, '‚è≥ Connecting...', 'info');

        try {
            const response = await fetch('/api/github/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repo_url: repoUrl })
            });

            const data = await response.json();

            if (response.ok) {
                showStatus(githubStatus, `‚úÖ ${data.message}`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showStatus(githubStatus, `‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showStatus(githubStatus, `‚ùå Error: ${error.message}`, 'error');
        } finally {
            connectBtn.disabled = false;
        }
    });

    // Clear RAG database
    clearRagBtn.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to clear all documents? This cannot be undone.')) {
            return;
        }

        clearRagBtn.disabled = true;
        showStatus(ragStatus, '‚è≥ Clearing database...', 'info');

        try {
            const response = await fetch('/api/rag/clear', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                showStatus(ragStatus, '‚úÖ Database cleared successfully', 'success');
                document.getElementById('total-chunks').textContent = '0';
            } else {
                showStatus(ragStatus, `‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showStatus(ragStatus, `‚ùå Error: ${error.message}`, 'error');
        } finally {
            clearRagBtn.disabled = false;
        }
    });

    // Load workflows
    loadWorkflowsBtn.addEventListener('click', async () => {
        loadWorkflowsBtn.disabled = true;
        showStatus(workflowStatus, '‚è≥ Loading workflows...', 'info');
        workflowsContainer.innerHTML = '';

        try {
            const response = await fetch('/api/github/workflows');
            const data = await response.json();

            if (response.ok && data.workflows) {
                if (data.workflows.length === 0) {
                    workflowsContainer.innerHTML = '<p class="help-text">No workflows found in this repository.</p>';
                } else {
                    const workflowList = document.createElement('div');
                    workflowList.className = 'workflow-list';

                    data.workflows.forEach(wf => {
                        const workflowCard = document.createElement('div');
                        workflowCard.className = 'workflow-card';
                        workflowCard.innerHTML = `
                        <div class="workflow-info">
                            <strong>${wf.name}</strong>
                            <span class="workflow-path">${wf.path}</span>
                        </div>
                        <button class="btn-small trigger-btn" data-id="${wf.id}" data-name="${wf.name}">
                            ‚ñ∂Ô∏è Trigger
                        </button>
                    `;
                        workflowList.appendChild(workflowCard);
                    });

                    workflowsContainer.appendChild(workflowList);

                    // Add event listeners to trigger buttons
                    document.querySelectorAll('.trigger-btn').forEach(btn => {
                        btn.addEventListener('click', () => triggerWorkflow(btn.dataset.id, btn.dataset.name));
                    });
                }
                showStatus(workflowStatus, '', '');
            } else {
                showStatus(workflowStatus, `‚ùå ${data.error || 'Failed to load workflows'}`, 'error');
            }
        } catch (error) {
            showStatus(workflowStatus, `‚ùå Error: ${error.message}`, 'error');
        } finally {
            loadWorkflowsBtn.disabled = false;
        }
    });

    // Trigger workflow
    async function triggerWorkflow(workflowId, workflowName) {
        if (!confirm(`Trigger workflow: ${workflowName}?`)) {
            return;
        }

        showStatus(workflowStatus, `‚è≥ Triggering ${workflowName}...`, 'info');

        try {
            const response = await fetch('/api/github/workflow/trigger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    workflow_id: workflowId,
                    ref: 'main'
                })
            });

            const data = await response.json();

            if (response.ok) {
                showStatus(workflowStatus, `‚úÖ ${data.message}`, 'success');
            } else {
                showStatus(workflowStatus, `‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showStatus(workflowStatus, `‚ùå Error: ${error.message}`, 'error');
        }
    }

    function showStatus(element, message, type) {
        element.textContent = message;
        element.className = `status-message ${type}`;
    }

        // SOX Analysis Workflow
        const triggerSoxBtn = document.getElementById('trigger-sox-btn');
        const soxControlName = document.getElementById('sox-control-name');
        const soxControlData = document.getElementById('sox-control-data');
        const soxAnalysisType = document.getElementById('sox-analysis-type');
        const soxWorkflowStatus = document.getElementById('sox-workflow-status');
        const soxProgress = document.getElementById('sox-progress');
        const soxRunId = document.getElementById('sox-run-id');
        const soxRunStatus = document.getElementById('sox-run-status');
        const checkSoxArtifactBtn = document.getElementById('check-sox-artifact-btn');

        let currentSoxRunId = null;

        triggerSoxBtn.addEventListener('click', async () => {
            const controlName = soxControlName.value.trim();
            const controlData = soxControlData.value.trim();
            const analysisType = soxAnalysisType.value;

            if (!controlName || !controlData) {
                showStatus(soxWorkflowStatus, '‚ùå Please enter control name and data', 'error');
                return;
            }

            showStatus(soxWorkflowStatus, '‚è≥ Triggering SOX analysis workflow...', 'info');
            triggerSoxBtn.disabled = true;

            try {
                const response = await fetch('/api/github/process-analysis/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        process_name: controlName,
                        process_data: controlData,
                        analysis_type: analysisType
                    })
                });

                const data = await response.json();

                if (response.ok && data.run_id) {
                    currentSoxRunId = data.run_id;
                    soxRunId.textContent = data.run_id;
                    soxRunStatus.textContent = 'Running...';
                    soxProgress.style.display = 'block';
                    showStatus(soxWorkflowStatus, '‚úÖ Workflow triggered! Check GitHub Actions for progress.', 'success');
                } else {
                    showStatus(soxWorkflowStatus, `‚ùå Error: ${data.error || 'Failed to trigger workflow'}`, 'error');
                }
            } catch (error) {
                showStatus(soxWorkflowStatus, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                triggerSoxBtn.disabled = false;
            }
        });

        checkSoxArtifactBtn.addEventListener('click', async () => {
            if (!currentSoxRunId) {
                showStatus(soxWorkflowStatus, '‚ùå No workflow run ID available', 'error');
                return;
            }

            showStatus(soxWorkflowStatus, '‚è≥ Checking for artifacts...', 'info');
            checkSoxArtifactBtn.disabled = true;

            try {
                const response = await fetch(`/api/github/artifacts/check/${currentSoxRunId}`);
                const data = await response.json();

                if (data.success) {
                    soxRunStatus.textContent = '‚úÖ Completed';
                    showStatus(soxWorkflowStatus, `‚úÖ ${data.message}. Downloading...`, 'success');

                    // Refresh reports list
                    loadReports();

                    // Trigger download
                    if (data.download_url) {
                        window.location.href = data.download_url;
                    }
                } else if (data.status === 'in_progress' || data.status === 'queued') {
                    soxRunStatus.textContent = `‚è≥ ${data.status}`;
                    showStatus(soxWorkflowStatus, `‚è≥ ${data.message || 'Workflow still running...'}`, 'info');
                } else {
                    showStatus(soxWorkflowStatus, `‚ùå ${data.error || data.message}`, 'error');
                }
            } catch (error) {
                showStatus(soxWorkflowStatus, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                checkSoxArtifactBtn.disabled = false;
            }
        });

        // Generated Reports Management
        const refreshReportsBtn = document.getElementById('refresh-reports-btn');
        const cleanupReportsBtn = document.getElementById('cleanup-reports-btn');
        const reportsList = document.getElementById('reports-list');
        const reportsStatus = document.getElementById('reports-status');

        async function loadReports() {
            try {
                const response = await fetch('/api/reports/list');
                const data = await response.json();

                if (response.ok && data.reports) {
                    if (data.reports.length === 0) {
                        reportsList.innerHTML = '<p class="info-text">No reports generated yet.</p>';
                    } else {
                        let html = '<table class="reports-table" style="width: 100%; border-collapse: collapse;">';
                        html += '<thead><tr><th style="text-align: left; padding: 0.5rem; border-bottom: 2px solid #ddd;">Filename</th>';
                        html += '<th style="text-align: left; padding: 0.5rem; border-bottom: 2px solid #ddd;">Created</th>';
                        html += '<th style="text-align: right; padding: 0.5rem; border-bottom: 2px solid #ddd;">Size</th>';
                        html += '<th style="text-align: center; padding: 0.5rem; border-bottom: 2px solid #ddd;">Action</th></tr></thead><tbody>';

                        data.reports.forEach(report => {
                            const sizeKB = (report.size / 1024).toFixed(2);
                            html += `<tr>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${report.filename}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${report.created}</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #eee; text-align: right;">${sizeKB} KB</td>
                            <td style="padding: 0.5rem; border-bottom: 1px solid #eee; text-align: center;">
                                <a href="/api/download/${report.filename}" class="btn-small" style="text-decoration: none;">üì• Download</a>
                            </td>
                        </tr>`;
                        });

                        html += '</tbody></table>';
                        reportsList.innerHTML = html;
                    }
                } else {
                    reportsList.innerHTML = '<p class="error-text">Failed to load reports</p>';
                }
            } catch (error) {
                reportsList.innerHTML = `<p class="error-text">Error: ${error.message}</p>`;
            }
        }

        refreshReportsBtn.addEventListener('click', () => {
            loadReports();
            showStatus(reportsStatus, '‚úÖ Reports list refreshed', 'success');
            setTimeout(() => showStatus(reportsStatus, '', ''), 2000);
        });

        cleanupReportsBtn.addEventListener('click', async () => {
            if (!confirm('Delete all reports older than 24 hours?')) {
                return;
            }

            showStatus(reportsStatus, '‚è≥ Cleaning up old reports...', 'info');
            cleanupReportsBtn.disabled = true;

            try {
                const response = await fetch('/api/reports/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ hours: 24 })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(reportsStatus, `‚úÖ ${data.message}`, 'success');
                    loadReports();
                } else {
                    showStatus(reportsStatus, `‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(reportsStatus, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                cleanupReportsBtn.disabled = false;
            }
        });

        // Load reports on page load
        loadReports();

        // AI Prompt Configuration
        const promptTemplate = document.getElementById('prompt-template');
        const customPromptEditor = document.getElementById('custom-prompt-editor');
        const customPromptText = document.getElementById('custom-prompt-text');
        const templatePreview = document.getElementById('preview-text');
        const updatePromptBtn = document.getElementById('update-prompt-btn');
        const resetPromptBtn = document.getElementById('reset-prompt-btn');
        const promptStatus = document.getElementById('prompt-status');

        let promptTemplates = {};

        // Load available prompt templates
        async function loadPromptTemplates() {
            try {
                const response = await fetch('/api/prompts/templates');
                const data = await response.json();

                if (response.ok) {
                    promptTemplates = data.templates;
                    
                    // Set current template
                    if (data.current_template) {
                        promptTemplate.value = data.current_template;
                    }
                    
                    // Update preview
                    updatePreview();
                }
            } catch (error) {
                console.error('Error loading prompt templates:', error);
            }
        }

        // Update preview text
        function updatePreview() {
            const selected = promptTemplate.value;
            
            if (selected === 'custom') {
                templatePreview.textContent = customPromptText.value || 'Enter your custom prompt above...';
            } else if (promptTemplates[selected]) {
                templatePreview.textContent = promptTemplates[selected];
            }
        }

        // Toggle custom prompt editor
        promptTemplate.addEventListener('change', () => {
            const selected = promptTemplate.value;
            
            if (selected === 'custom') {
                customPromptEditor.style.display = 'block';
            } else {
                customPromptEditor.style.display = 'none';
            }
            
            updatePreview();
        });

        // Update preview when typing custom prompt
        customPromptText.addEventListener('input', updatePreview);

        // Update prompt
        updatePromptBtn.addEventListener('click', async () => {
            const selected = promptTemplate.value;
            let requestBody = {};

            if (selected === 'custom') {
                const customText = customPromptText.value.trim();
                if (!customText) {
                    showStatus(promptStatus, '‚ùå Please enter a custom prompt', 'error');
                    return;
                }
                requestBody.custom_prompt = customText;
            } else {
                requestBody.template = selected;
            }

            updatePromptBtn.disabled = true;
            showStatus(promptStatus, '‚è≥ Updating prompt...', 'info');

            try {
                const response = await fetch('/api/prompts/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(promptStatus, `‚úÖ ${data.message}`, 'success');
                    updatePreview();
                } else {
                    showStatus(promptStatus, `‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(promptStatus, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                updatePromptBtn.disabled = false;
            }
        });

        // Reset prompt to default
        resetPromptBtn.addEventListener('click', async () => {
            if (!confirm('Reset to default prompt? This will clear any custom settings.')) {
                return;
            }

            resetPromptBtn.disabled = true;
            showStatus(promptStatus, '‚è≥ Resetting prompt...', 'info');

            try {
                const response = await fetch('/api/prompts/reset', {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(promptStatus, `‚úÖ ${data.message}`, 'success');
                    promptTemplate.value = 'default';
                    customPromptEditor.style.display = 'none';
                    customPromptText.value = '';
                    updatePreview();
                } else {
                    showStatus(promptStatus, `‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(promptStatus, `‚ùå Error: ${error.message}`, 'error');
            } finally {
                resetPromptBtn.disabled = false;
            }
        });

        // Load prompt templates on page load
        loadPromptTemplates();

    // Document Template Configuration
    const projectNameInput = document.getElementById('project-name');
    const companyNameInput = document.getElementById('company-name');
    const brandColorInput = document.getElementById('brand-color');
    const brandColorPicker = document.getElementById('brand-color-picker');
    const defaultTemplateSelect = document.getElementById('default-template');
    const logoPathInput = document.getElementById('logo-path');
    const saveDocConfigBtn = document.getElementById('save-doc-config-btn');
    const resetDocConfigBtn = document.getElementById('reset-doc-config-btn');
    const docConfigStatus = document.getElementById('doc-config-status');

    // Preview elements
    const previewHeader = document.getElementById('preview-header');
    const previewColorBox = document.getElementById('preview-color-box');
    const previewColorText = document.getElementById('preview-color-text');
    const previewTemplate = document.getElementById('preview-template');

    // Template name mapping
    const templateNames = {
        'generic': 'Generic - General Purpose Documentation',
        'sox_audit': 'SOX Audit - Compliance Reports',
        'mlops_workflow': 'MLOps Workflow - ML Pipeline Docs',
        'devops_pipeline': 'DevOps Pipeline - CI/CD Documentation'
    };

    // Load current document configuration
    async function loadDocConfig() {
        try {
            const response = await fetch('/api/doc-config/current');
            const data = await response.json();

            if (response.ok) {
                projectNameInput.value = data.project_name || 'GitHub Process Manager';
                companyNameInput.value = data.company_name || '';
                brandColorInput.value = data.brand_color || '#4A90E2';
                brandColorPicker.value = data.brand_color || '#4A90E2';
                defaultTemplateSelect.value = data.default_template || 'generic';
                logoPathInput.value = data.logo_path || '';
                
                updateDocConfigPreview();
            }
        } catch (error) {
            console.error('Error loading document config:', error);
        }
    }

    // Update preview
    function updateDocConfigPreview() {
        const projectName = projectNameInput.value || 'GitHub Process Manager';
        const companyName = companyNameInput.value;
        const brandColor = brandColorInput.value || '#4A90E2';
        const templateType = defaultTemplateSelect.value;

        // Update header preview
        if (companyName) {
            previewHeader.textContent = `${companyName} | ${projectName} | Process Documentation`;
        } else {
            previewHeader.textContent = `${projectName} | Process Documentation`;
        }

        // Update color preview
        previewColorBox.style.backgroundColor = brandColor;
        previewColorText.textContent = brandColor;

        // Update template preview
        previewTemplate.textContent = templateNames[templateType] || templateType;
    }

    // Sync color picker with text input
    brandColorPicker.addEventListener('input', () => {
        brandColorInput.value = brandColorPicker.value;
        updateDocConfigPreview();
    });

    brandColorInput.addEventListener('input', () => {
        const color = brandColorInput.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
            brandColorPicker.value = color;
            updateDocConfigPreview();
        }
    });

    // Update preview on input changes
    projectNameInput.addEventListener('input', updateDocConfigPreview);
    companyNameInput.addEventListener('input', updateDocConfigPreview);
    defaultTemplateSelect.addEventListener('change', updateDocConfigPreview);

    // Save document configuration
    saveDocConfigBtn.addEventListener('click', async () => {
        const config = {
            project_name: projectNameInput.value || 'GitHub Process Manager',
            company_name: companyNameInput.value,
            brand_color: brandColorInput.value || '#4A90E2',
            default_template: defaultTemplateSelect.value,
            logo_path: logoPathInput.value
        };

        // Validate hex color
        if (!/^#[0-9A-Fa-f]{6}$/.test(config.brand_color)) {
            showStatus(docConfigStatus, '‚ùå Invalid color format. Use hex format like #4A90E2', 'error');
            return;
        }

        saveDocConfigBtn.disabled = true;
        showStatus(docConfigStatus, '‚è≥ Saving configuration...', 'info');

        try {
            const response = await fetch('/api/doc-config/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            });

            const data = await response.json();

            if (response.ok) {
                showStatus(docConfigStatus, `‚úÖ ${data.message}`, 'success');
                updateDocConfigPreview();
            } else {
                showStatus(docConfigStatus, `‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showStatus(docConfigStatus, `‚ùå Error: ${error.message}`, 'error');
        } finally {
            saveDocConfigBtn.disabled = false;
        }
    });

    // Reset document configuration
    resetDocConfigBtn.addEventListener('click', async () => {
        if (!confirm('Reset to default configuration? This will clear custom branding.')) {
            return;
        }

        resetDocConfigBtn.disabled = true;
        showStatus(docConfigStatus, '‚è≥ Resetting configuration...', 'info');

        try {
            const response = await fetch('/api/doc-config/reset', {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                showStatus(docConfigStatus, `‚úÖ ${data.message}`, 'success');
                // Reload config from defaults
                projectNameInput.value = 'GitHub Process Manager';
                companyNameInput.value = '';
                brandColorInput.value = '#4A90E2';
                brandColorPicker.value = '#4A90E2';
                defaultTemplateSelect.value = 'generic';
                logoPathInput.value = '';
                updateDocConfigPreview();
            } else {
                showStatus(docConfigStatus, `‚ùå Error: ${data.error}`, 'error');
            }
        } catch (error) {
            showStatus(docConfigStatus, `‚ùå Error: ${error.message}`, 'error');
        } finally {
            resetDocConfigBtn.disabled = false;
        }
    });

    // Load document config on page load
    loadDocConfig();

</script>
{% endblock %}